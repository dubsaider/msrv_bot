# Telegram Бот с Транскрипцией Аудио и Пользовательскими Ответами

Этот Telegram бот разработан на `aiogram` и предоставляет функциональность обработки текстовых, голосовых сообщений и видеозаметок ("кружочков"), включая транскрипцию аудио и уникальные текстовые реакции.

## Описание

Бот умеет:
  - Отвечать на определенные текстовые фразы, настроенные заранее.
  - Вести *общий* счетчик упоминаний заданных ключевых слов (имен, например, "Паша", "Захар", "Дед") в групповых чатах и автоматически отправлять благодарственное сообщение при достижении заданного порога.
  - Транскрибировать голосовые сообщения и видеозаметки, отправляя их во внешний API сервис для распознавания речи.

## Особенности
  - Обработка текстовых сообщений:
    - Автоматические ответы на заранее заданные ключевые фразы (конфигурируются в `constants/answers.py`).
    - Система учета упоминаний *нескольких* заданных имен (и их различных вариаций) в групповых чатах. При достижении *общего* порога (`GLOBAL_MENTION_THRESHOLD`) бот отправляет сообщение формата `#СпасибоИмя` (где "Имя" — последнее распознанное ключевое слово, например, `#СпасибоПаша` или `#СпасибоЗахар`) и сбрасывает счетчик для данного чата.
  - Транскрипция голосовых сообщений и видеозаметок:
    - Скачивает прикрепленные голосовые сообщения и видеозаметки.
    - Отправляет аудиоданные на внешний сервис транскрипции (URL конфигурируется через `TRANSCRIBE_API`).
    - Публикует полученный транскрибированный текст как цитату в чат.
  - Легкая развертывание: Проект готов к развертыванию с помощью Docker и Docker Compose.

## Требования

Для запуска бота вам понадобится:
  - `Docker` и `Docker Compose`
  - Python 3.9+
  - Токен Telegram бота (получается у `@BotFather`)
  - URL внешнего API сервиса для транскрипции аудио (например, API на базе Whisper).

## Установка и Запуск

Выполните следующие шаги для установки и запуска бота:

1.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/dubsaider/msrv_bot.git
    cd msrv_bot
    ```

2.  Создайте файл `.env`:
    Создайте файл с именем `.env` в корневой директории проекта и добавьте в него следующие переменные окружения:
    ```
    BOT_TOKEN=ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН
    TRANSCRIBE_API=http://АДРЕС_ВАШЕГО_API_ТРАНСКРИПЦИИ:ПОРТ/transcribe
    ```
  - `BOT_TOKEN`: Токен, полученный от BotFather.
  - `TRANSCRIBE_API`: Полный URL вашего сервиса транскрипции. Убедитесь, что бот имеет доступ к этому адресу.

3.  Запустите бот с помощью Docker Compose:
    ```bash
    docker-compose up --build -d
    ```
  - `--build`: Собирает образ Docker, если он еще не создан или если изменения в Dockerfile.
  - `-d`: Запускает контейнер в фоновом режиме (detached mode).

Бот будет запущен и готов к работе. Вы можете проверить статус контейнера:
```bash
docker-compose ps
```

## Конфигурация

Вы можете настроить поведение бота, изменив следующие файлы:
  - `config.py`: Загружает переменные окружения `BOT_TOKEN` и `TRANSCRIBE_API`.
  - `constants/answers.py`: Словарь `ANSWERS` для настройки пользовательских текстовых ответов. Ключ — фраза пользователя (в нижнем регистре), значение — ответ бота.
    ```python
    ANSWERS = {
        "да": "пизда",
        "net": "пидора ответ",
        "здрасьте": "забор покрасьте",
        "300": "отсоси у тракториста",
        # ... добавьте свои пары ключ-значение
    }
    ```
  - `constants/mention_config.py`: Этот файл содержит настройки для *общего* счетчика упоминаний различных сущностей.
  - `ALL_MENTION_PATTERNS`: Список кортежей, где каждый кортеж содержит базовое имя (например, "Паша") и скомпилированное регулярное выражение для распознавания его различных вариаций.
  - `GLOBAL_MENTION_THRESHOLD`: Единый числовой порог упоминаний для всего чата, после которого сработает благодарственное сообщение.
  - `generate_thanks_message(name: str)`: Функция, генерирующая текст благодарственного сообщения на основе базового имени.
    ```python
    # constants/mention_config.py
    import re

    ALL_MENTION_PATTERNS = [
        ("Паша", re.compile(r'\bпаш(а|ей|у|е|и|енька|ка)?\b', re.IGNORECASE)),
        ("Захар", re.compile(r'\bзахар(а|у|ом|е|чик|ка)?\b', re.IGNORECASE)),
        ("Дед", re.compile(r'\bдед(а|у|ом|е|ок|ушка)?\b', re.IGNORECASE)),
        # ... добавьте свои имена и паттерны
    ]

    GLOBAL_MENTION_THRESHOLD = 5 # Единый порог для всех упоминаний в чате

    def generate_thanks_message(name: str) -> str:
        return f"#Спасибо{name}" # Например, "#СпасибоПаша" или "#СпасибоЗахар"
    ```

## Использование

1.  Добавьте бота: Добавьте вашего бота в нужный групповой чат или начните личную переписку.
2.  Текстовые ответы: Отправляйте текстовые сообщения, содержащие фразы из `constants/answers.py`, чтобы получить ответ бота.
3.  Счетчик упоминаний: В групповом чате набирайте ключевые слова или их варианты, настроенные в `constants/mention_config.py` (например, "Паша", "Захар", "Дед"). Как только *общее количество* упоминаний достигнет порога, бот автоматически отправит благодарственное сообщение.
4.  Транскрипция аудио: Отправляйте голосовые сообщения или видеозаметки ("кружочки"). Бот обработает их и пришлет транскрипцию в виде цитаты.

## Структура Проекта
```
.
├── .dockerignore
├── .env                  # Переменные окружения (BOT_TOKEN, TRANSCRIBE_API)
├── .gitignore            # Файлы, игнорируемые Git
├── config.py             # Загрузка конфигурации из .env
├── constants/            # Константы и настройки
│   ├── answers.py        # Настраиваемые текстовые ответы
│   ├── mention_config.py # Настройки универсального счетчика упоминаний
│   └── __init__.py
├── docker-compose.yaml   # Конфигурация для Docker Compose
├── Dockerfile            # Инструкции для сборки Docker образа
├── handlers/             # Обработчики сообщений
│   ├── audio_handlers.py # Обработка голосовых сообщений и видеозаметок
│   ├── pasha_counter_handler.py # Логика счетчика упоминаний (общая)
│   ├── text_handlers.py  # Обработка текстовых сообщений
│   └── __init__.py
├── main.py               # Точка входа в бота, регистрация обработчиков
├── README.md             # Этот файл
├── requirements.txt      # Зависимости Python
└── services/
    ├── transcription_service.py # Сервис для взаимодействия с API транскрипции
    └── __init__.py
```

## Вклад в Проект

Если вы хотите внести свой вклад в проект, пожалуйста, следуйте стандартным рекомендациям по разработке:
1.  Сделайте форк репозитория.
2.  Создайте новую ветку для ваших изменений.
3.  Внесите изменения и протестируйте их.
4.  Отправьте pull-request с описанием ваших изменений.

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности смотрите в файле LICENSE (если применимо).
